{% extends "base.html" %}

{% block title %}Spirograph Generator - {{ app_name or 'Dune Weaver' }}{% endblock %}

{% block content %}
<div class="flex flex-1 flex-col gap-8 px-4 py-5 max-w-5xl mx-auto w-full text-gray-900 dark:text-gray-100">
  <!-- Header -->
  <div class="flex flex-col gap-3"> 
    <div class="text-3xl font-extrabold text-gray-900 dark:text-gray-100">
      <span class="material-icons align-middle text-3xl">layers</span>
      Spirograph Generator
    </div>
    <p class="text-base text-gray-500 dark:text-gray-400">
      Generate mathematical spirograph patterns for your sand table. Choose from presets or create custom patterns.
    </p>
  </div>

  <!-- Tabs -->
  <div class="flex gap-2 border-b border-gray-200 dark:border-gray-700">
    <button id="tab-presets" class="tab-button active px-4 py-2 font-medium text-sm border-b-2 transition-colors">
      Presets
    </button>
    <button id="tab-custom" class="tab-button px-4 py-2 font-medium text-sm border-b-2 border-transparent transition-colors">
      Custom
    </button>
  </div>

  <!-- Preset Tab -->
  <div id="preset-section" class="tab-content">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
      <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">Choose a Preset</h2>
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Select Preset Pattern
        </label>
        <select id="preset-select" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200">
          <option value="">-- Select a preset --</option>
        </select>
      </div>

      <div id="preset-info" class="mb-4 p-4 rounded-lg hidden bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-100">
        <h3 class="font-medium text-gray-900 dark:text-gray-100 mb-2">Pattern Details</h3>
        <div id="preset-details" class="text-sm text-gray-600 dark:text-gray-300"></div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Filename
        </label>
        <div class="flex gap-2">
          <input
            id="preset-filename"
            type="text"
            placeholder="my-spirograph"
            class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200"
          />
          <span class="flex items-center text-gray-500 dark:text-gray-400">.thr</span>
        </div>
      </div>

      <button
        id="generate-preset-btn"
        class="w-full px-4 py-3 bg-sky-600 hover:bg-sky-700 text-white font-medium rounded-lg transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
        disabled
      >
        Generate Pattern
      </button>
    </div>
  </div>

  <!-- Custom Tab -->
  <div id="custom-section" class="tab-content hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
      <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">Custom Pattern</h2>

      <!-- Pattern Type -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Pattern Type
        </label>
        <select id="pattern-type" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200">
          <option value="hypotrochoid">Hypotrochoid (Inner Spirograph)</option>
          <option value="epitrochoid">Epitrochoid (Outer Spirograph)</option>
          <option value="rose">Rose Curve</option>
          <option value="lissajous">Lissajous Figure</option>
        </select>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="pattern-type-help">
          Classic spirograph with small circle rolling inside large circle
        </p>
      </div>

      <!-- Dynamic Parameters -->
      <div id="params-hypotrochoid" class="params-section">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              R (Fixed Circle)
            </label>
            <input type="number" id="param-R" value="1.0" step="0.01" min="0.1" max="2"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200" />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Typically 1.0</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              r (Rolling Circle)
            </label>
            <input type="number" id="param-r" value="0.23" step="0.01" min="0.01" max="1"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200" />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Try 0.2-0.5</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              d (Pen Distance)
            </label>
            <input type="number" id="param-d" value="0.5" step="0.01" min="0.01" max="2"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200" />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Try 0.5-1.5 × r</p>
          </div>
        </div>
      </div>

      <div id="params-epitrochoid" class="params-section hidden">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              R (Fixed Circle)
            </label>
            <input type="number" id="param-epi-R" value="1.0" step="0.01" min="0.1" max="2"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200" />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Typically 1.0</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              r (Rolling Circle)
            </label>
            <input type="number" id="param-epi-r" value="0.23" step="0.01" min="0.01" max="1"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200" />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Try 0.2-0.5</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              d (Pen Distance)
            </label>
            <input type="number" id="param-epi-d" value="0.5" step="0.01" min="0.01" max="2"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200" />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Try 0.5-1.5 × r</p>
          </div>
        </div>
      </div>

      <div id="params-rose" class="params-section hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              n (Petals)
            </label>
            <input type="number" id="param-n" value="10" step="1" min="1" max="200"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200" />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Number of petals</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              d (Denominator)
            </label>
            <input type="number" id="param-rose-d" value="1" step="1" min="1" max="10"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200" />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Usually 1</p>
          </div>
        </div>
      </div>

      <div id="params-lissajous" class="params-section hidden">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              a (X Frequency)
            </label>
            <input type="number" id="param-a" value="3" step="0.1" min="0.1" max="10"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200" />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Try 2-7</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              b (Y Frequency)
            </label>
            <input type="number" id="param-b" value="4" step="0.1" min="0.1" max="10"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200" />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Try 2-7</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              δ (Phase Shift)
            </label>
            <input type="number" id="param-delta" value="0" step="0.1" min="0" max="6.28"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200" />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">0 to 2π (6.28)</p>
          </div>
        </div>
      </div>

      <!-- Common Parameters -->
      <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mb-4">
        <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Common Settings</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Points
            </label>
            <input type="number" id="param-points" value="8000" step="100" min="100" max="50000"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200" />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">More = smoother</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Scale
            </label>
            <input type="number" id="param-scale" value="0.95" step="0.05" min="0.1" max="1"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200" />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">0.1 to 1.0</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Center Offset
            </label>
            <input type="number" id="param-offset" value="0" step="0.05" min="0" max="0.5"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200" />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">0 to 0.5</p>
          </div>
        </div>
      </div>

      <!-- Filename -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Filename
        </label>
        <div class="flex gap-2">
          <input
            id="custom-filename"
            type="text"
            placeholder="my-custom-spirograph"
            class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200"
          />
          <span class="flex items-center text-gray-500 dark:text-gray-400">.thr</span>
        </div>
      </div>

      <button
        id="generate-custom-btn"
        class="w-full px-4 py-3 bg-sky-600 hover:bg-sky-700 text-white font-medium rounded-lg transition-colors"
      >
        Generate Custom Pattern
      </button>
    </div>
  </div>

  <!-- Status Messages -->
  <div id="status-message" class="hidden p-4 rounded-lg"></div>

  <!-- Pattern Preview Canvas -->
  <div id="preview-container" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mt-4">
    <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">Pattern Preview</h2>
    <div class="flex justify-center mb-4">
      <canvas id="pattern-preview-canvas" width="500" height="500" class="border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-900"></canvas>
    </div>
    <div class="flex gap-2 justify-center">
      <button id="save-pattern-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors">
        Save to Library
      </button>
      <button id="edit-pattern-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors">
        Edit Parameters
      </button>
    </div>
  </div>

  <!-- Info Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
    <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-4 border border-blue-200 dark:border-blue-700">
      <h3 class="flex items-center gap-2 font-semibold mb-2">
        <span class="material-icons text-base">info</span>
        What is a Spirograph?
      </h3>
      <p class="text-sm">
        A spirograph is a pattern created by tracing a point on a circle as it rolls around another circle.
        Hypotrochoids roll inside, epitrochoids roll outside. Experiment with different parameters for unique designs!
      </p>
    </div>
    <div class="rounded-lg p-4 border border-green-200 dark:border-green-700 bg-white dark:bg-gray-800">
      <h3 class="flex items-center gap-2 font-semibold mb-2">
        <span class="material-icons text-base">tips_and_updates</span>
        Quick Tips
      </h3>
      <ul class="text-sm space-y-1">
        <li>• Smaller r values create more petals</li>
        <li>• Adjust d for different petal shapes</li>
        <li>• Use scale < 1.0 to stay within bounds</li>
      </ul>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Tab switching
  const tabButtons = document.querySelectorAll('.tab-button');
  const presetSection = document.getElementById('preset-section');
  const customSection = document.getElementById('custom-section');

  document.getElementById('tab-presets').addEventListener('click', () => {
    tabButtons.forEach(btn => btn.classList.remove('active'));
    document.getElementById('tab-presets').classList.add('active');
    presetSection.classList.remove('hidden');
    customSection.classList.add('hidden');
  });

  document.getElementById('tab-custom').addEventListener('click', () => {
    tabButtons.forEach(btn => btn.classList.remove('active'));
    document.getElementById('tab-custom').classList.add('active');
    customSection.classList.remove('hidden');
    presetSection.classList.add('hidden');
  });

  // Load presets
  async function loadPresets() {
    try {
      const response = await fetch('/api/spirograph/presets');
      const data = await response.json();
      
      const select = document.getElementById('preset-select');
      select.innerHTML = '<option value="">-- Select a preset --</option>';
      
      data.presets.forEach(preset => {
        const option = document.createElement('option');
        option.value = preset;
        option.textContent = preset.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        select.appendChild(option);
      });

      // Store preset details
      window.presetDetails = data.preset_details;
    } catch (error) {
      console.error('Failed to load presets:', error);
    }
  }

  // Show preset info
  document.getElementById('preset-select').addEventListener('change', (e) => {
    const presetName = e.target.value;
    const generateBtn = document.getElementById('generate-preset-btn');
    const infoDiv = document.getElementById('preset-info');
    const detailsDiv = document.getElementById('preset-details');

    if (!presetName) {
      generateBtn.disabled = true;
      infoDiv.classList.add('hidden');
      return;
    }

    generateBtn.disabled = false;
    const preset = window.presetDetails[presetName];
    
    let detailsHtml = `<p><strong>Type:</strong> ${preset.type}</p><p><strong>Parameters:</strong></p><ul class="list-disc list-inside">`;
    for (const [key, value] of Object.entries(preset.params)) {
      detailsHtml += `<li>${key}: ${value}</li>`;
    }
    detailsHtml += '</ul>';
    
    detailsDiv.innerHTML = detailsHtml;
    infoDiv.classList.remove('hidden');

    // Auto-fill filename
    document.getElementById('preset-filename').value = presetName;
  });

  // Pattern type descriptions
  const typeDescriptions = {
    hypotrochoid: 'Classic spirograph with small circle rolling inside large circle',
    epitrochoid: 'Small circle rolling outside a large circle',
    rose: 'Rose curve with n petals (equation: r = cos(n/d * θ))',
    lissajous: 'Complex figure-eight patterns from harmonic oscillations'
  };

  // Handle pattern type change
  document.getElementById('pattern-type').addEventListener('change', (e) => {
    const type = e.target.value;
    document.getElementById('pattern-type-help').textContent = typeDescriptions[type];

    // Show/hide parameter sections
    document.querySelectorAll('.params-section').forEach(section => {
      section.classList.add('hidden');
    });

    const activeSection = document.getElementById(`params-${type}`);
    if (activeSection) {
      activeSection.classList.remove('hidden');
    }
  });

  // Store current pattern data for preview
  let currentPatternData = null;

  // Draw pattern preview on canvas
  function drawPatternPreview(coordinates) {
    const canvas = document.getElementById('pattern-preview-canvas');
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const scale = (canvas.width / 2) * 0.9; // 90% of radius for padding

    // Clear canvas
    ctx.fillStyle = getComputedStyle(canvas).backgroundColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Draw center point
    ctx.fillStyle = '#94a3b8';
    ctx.beginPath();
    ctx.arc(centerX, centerY, 3, 0, Math.PI * 2);
    ctx.fill();

    // Draw pattern
    ctx.strokeStyle = '#0c7ff2';
    ctx.lineWidth = 1;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    ctx.beginPath();
    for (let i = 0; i < coordinates.length; i++) {
      const [theta, rho] = coordinates[i];
      const x = centerX + rho * scale * Math.cos(theta);
      const y = centerY + rho * scale * Math.sin(theta);
      
      if (i === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    }
    ctx.stroke();

    // Draw start point
    if (coordinates.length > 0) {
      const [theta, rho] = coordinates[0];
      const x = centerX + rho * scale * Math.cos(theta);
      const y = centerY + rho * scale * Math.sin(theta);
      ctx.fillStyle = '#10b981';
      ctx.beginPath();
      ctx.arc(x, y, 4, 0, Math.PI * 2);
      ctx.fill();
    }

    // Show preview container
    document.getElementById('preview-container').classList.remove('hidden');
    document.getElementById('preview-container').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  // Helper function to compute gcd
  function gcd(a, b) {
    return b === 0 ? a : gcd(b, a % b);
  }

  // Helper function to compute fraction from decimal (simple approximation)
  function toFraction(decimal, maxDenom = 10000) {
    let num = 0, den = 1;
    for (let i = 1; i <= maxDenom; i++) {
      const rounded = Math.round(decimal * i);
      if (Math.abs(rounded / i - decimal) < 1e-10) {
        num = rounded;
        den = i;
        break;
      }
    }
    return { num, den };
  }

  // Generate coordinates client-side for preview
  function generateCoordinatesPreview(patternType, params) {
    const coordinates = [];
    const numPoints = params.num_points || 2000;
    const scale = params.scale || 0.95;
    const centerOffset = params.center_offset || 0;

    console.log(`generateCoordinatesPreview called with:`, {patternType, params, numPoints, scale, centerOffset});

    if (patternType === 'hypotrochoid' || patternType === 'epitrochoid') {
      const R = params.R;
      const r = params.r;
      const d = params.d;
      
      // Calculate period using fraction approximation
      const R_frac = toFraction(R);
      const r_frac = toFraction(r);
      
      // Calculate LCM: lcm(R, r) / r = numRotations
      // lcm(a/b, c/d) = lcm(a,c) / gcd(b,d)
      const lcm_num = (R_frac.num * r_frac.num) / gcd(R_frac.num, r_frac.num);
      const gcd_den = gcd(R_frac.den, r_frac.den);
      
      // numRotations = lcm(R,r) / r = (lcm_num/gcd_den) / (r_num/r_den)
      const numRotations = (lcm_num * r_frac.den) / (gcd_den * r_frac.num);
      const tMax = 2 * Math.PI * numRotations;
      
      console.log(`Spirograph: R=${R}, r=${r}, R_frac=${R_frac.num}/${R_frac.den}, r_frac=${r_frac.num}/${r_frac.den}, lcm_num=${lcm_num}, gcd_den=${gcd_den}, numRotations=${numRotations}, tMax=${tMax.toFixed(2)}`);
      
      let prevTheta = 0;
      for (let i = 0; i < numPoints; i++) {
        const t = (i / (numPoints - 1)) * tMax;
        let x, y;
        
        if (patternType === 'hypotrochoid') {
          x = (R - r) * Math.cos(t) + d * Math.cos((R - r) / r * t);
          y = (R - r) * Math.sin(t) - d * Math.sin((R - r) / r * t);
        } else {
          x = (R + r) * Math.cos(t) - d * Math.cos((R + r) / r * t);
          y = (R + r) * Math.sin(t) - d * Math.sin((R + r) / r * t);
        }
        
        const rho = Math.sqrt(x*x + y*y);
        let theta = Math.atan2(y, x);
        
        while (theta - prevTheta > Math.PI) theta -= 2 * Math.PI;
        while (theta - prevTheta < -Math.PI) theta += 2 * Math.PI;
        prevTheta = theta;
        
        const maxRho = patternType === 'hypotrochoid' ? R + d : R + r + d;
        const rhoNorm = Math.max(0, Math.min(1, (rho / maxRho) * scale + centerOffset));
        
        coordinates.push([theta, rhoNorm]);
      }
    } else if (patternType === 'rose') {
      const n = params.n;
      const d = params.rose_d || 1;
      const k = n / d;
      
      const tMax = (d % 2 === 0 || n % 2 === 0) ? 2 * Math.PI * d : Math.PI * d;
      
      for (let i = 0; i < numPoints; i++) {
        const t = (i / (numPoints - 1)) * tMax;
        const rhoRaw = Math.abs(Math.cos(k * t));
        const rhoNorm = Math.max(0, Math.min(1, rhoRaw * scale + centerOffset));
        coordinates.push([t, rhoNorm]);
      }
    } else if (patternType === 'lissajous') {
      const a = params.a;
      const b = params.b;
      const delta = params.delta || 0;
      
      // Calculate period using fraction approximation
      const a_frac = toFraction(a);
      const b_frac = toFraction(b);
      
      // lcm(a,b) / gcd(den_a, den_b)
      const lcm_num = (a_frac.num * b_frac.num) / gcd(a_frac.num, b_frac.num);
      const gcd_den = gcd(a_frac.den, b_frac.den);
      
      const period = 2 * Math.PI * (lcm_num / gcd_den);
      
      let prevTheta = 0;
      for (let i = 0; i < numPoints; i++) {
        const t = (i / (numPoints - 1)) * period;
        const x = Math.sin(a * t + delta);
        const y = Math.sin(b * t);
        
        const rho = Math.sqrt(x*x + y*y);
        let theta = Math.atan2(y, x);
        
        while (theta - prevTheta > Math.PI) theta -= 2 * Math.PI;
        while (theta - prevTheta < -Math.PI) theta += 2 * Math.PI;
        prevTheta = theta;
        
        const rhoNorm = Math.max(0, Math.min(1, (rho / Math.sqrt(2)) * scale + centerOffset));
        coordinates.push([theta, rhoNorm]);
      }
    }

    return coordinates;
  }

  // Generate preset
  document.getElementById('generate-preset-btn').addEventListener('click', async () => {
    const presetName = document.getElementById('preset-select').value;
    const filenameInput = document.getElementById('preset-filename');
    const filename = (filenameInput.value || 'tmp').trim();

    if (!presetName) {
      showStatus('Please select a preset', 'error');
      return;
    }

    // Ensure the field is populated so the user sees what will be saved
    filenameInput.value = filename;

    showStatus('Generating preview...', 'info');

    try {
      // Get preset parameters
      const preset = window.presetDetails[presetName];
      const coordinates = generateCoordinatesPreview(preset.type, preset.params);
      
      // Store for later saving
      currentPatternData = {
        type: 'preset',
        preset_name: presetName,
        filename: filename
      };
      
      // Draw preview
      drawPatternPreview(coordinates);
      showStatus('Preview ready! Review and save to library.', 'success');
    } catch (error) {
      showStatus(`Failed to generate preview: ${error.message}`, 'error');
    }
  });

  // Generate custom
  document.getElementById('generate-custom-btn').addEventListener('click', async () => {
    const patternType = document.getElementById('pattern-type').value;
    const filenameInput = document.getElementById('custom-filename');
    const filename = (filenameInput.value || 'tmp').trim();

    // Reflect the default back to the UI so the user sees the intended save name
    filenameInput.value = filename;

    const payload = {
      pattern_type: patternType,
      filename,
      num_points: parseInt(document.getElementById('param-points').value),
      scale: parseFloat(document.getElementById('param-scale').value),
      center_offset: parseFloat(document.getElementById('param-offset').value)
    };

    // Add type-specific parameters
    if (patternType === 'hypotrochoid') {
      payload.R = parseFloat(document.getElementById('param-R').value);
      payload.r = parseFloat(document.getElementById('param-r').value);
      payload.d = parseFloat(document.getElementById('param-d').value);
      console.log(`Custom ${patternType} payload:`, payload);
    } else if (patternType === 'epitrochoid') {
      payload.R = parseFloat(document.getElementById('param-epi-R').value);
      payload.r = parseFloat(document.getElementById('param-epi-r').value);
      payload.d = parseFloat(document.getElementById('param-epi-d').value);
      console.log(`Custom ${patternType} payload:`, payload);
    } else if (patternType === 'rose') {
      payload.n = parseInt(document.getElementById('param-n').value);
      payload.rose_d = parseInt(document.getElementById('param-rose-d').value);
    } else if (patternType === 'lissajous') {
      payload.a = parseFloat(document.getElementById('param-a').value);
      payload.b = parseFloat(document.getElementById('param-b').value);
      payload.delta = parseFloat(document.getElementById('param-delta').value);
    }

    showStatus('Generating preview...', 'info');

    try {
      // Generate preview
      const coordinates = generateCoordinatesPreview(patternType, payload);
      
      // Store for later saving
      currentPatternData = {
        type: 'custom',
        payload: payload
      };
      
      // Draw preview
      drawPatternPreview(coordinates);
      showStatus('Preview ready! Review and save to library.', 'success');
    } catch (error) {
      showStatus(`Failed to generate preview: ${error.message}`, 'error');
    }
  });

  // Save pattern to library
  document.getElementById('save-pattern-btn').addEventListener('click', async () => {
    if (!currentPatternData) {
      showStatus('No pattern to save', 'error');
      return;
    }

    showStatus('Saving to library...', 'info');

    try {
      let response;
      if (currentPatternData.type === 'preset') {
        response = await fetch('/api/spirograph/generate-preset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            preset_name: currentPatternData.preset_name,
            filename: currentPatternData.filename
          })
        });
      } else {
        response = await fetch('/api/spirograph/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(currentPatternData.payload)
        });
      }

      const data = await response.json();

      if (response.ok) {
        showStatus(`✓ Saved! Redirecting to browse...`, 'success');
        setTimeout(() => {
          window.location.href = '/';
        }, 1500);
      } else {
        showStatus(`Error: ${data.detail}`, 'error');
      }
    } catch (error) {
      showStatus(`Failed to save: ${error.message}`, 'error');
    }
  });

  // Edit pattern (go back to form)
  document.getElementById('edit-pattern-btn').addEventListener('click', () => {
    document.getElementById('preview-container').classList.add('hidden');
    currentPatternData = null;
    showStatus('Edit your parameters and generate again.', 'info');
  });

  function showStatus(message, type) {
    const statusDiv = document.getElementById('status-message');
    statusDiv.textContent = message;
    statusDiv.classList.remove('hidden', 'bg-blue-100', 'bg-green-100', 'bg-red-100', 
                                'text-blue-800', 'text-green-800', 'text-red-800',
                                'dark:bg-blue-900/20', 'dark:bg-green-900/20', 'dark:bg-red-900/20',
                                'dark:text-blue-200', 'dark:text-green-200', 'dark:text-red-200');
    
    if (type === 'success') {
      statusDiv.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900/20', 'dark:text-green-200');
    } else if (type === 'error') {
      statusDiv.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900/20', 'dark:text-red-200');
    } else {
      statusDiv.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900/20', 'dark:text-blue-200');
    }

    if (type !== 'info') {
      setTimeout(() => statusDiv.classList.add('hidden'), 5000);
    }
  }

  // Tab styling
  const style = document.createElement('style');
  style.textContent = `
    .tab-button {
      color: #64748b;
      border-color: transparent;
    }
    .tab-button:hover {
      color: #334155;
    }
    .tab-button.active {
      color: #0c7ff2;
      border-color: #0c7ff2;
    }
    .dark .tab-button {
      color: #94a3b8;
    }
    .dark .tab-button:hover {
      color: #cbd5e1;
    }
    .dark .tab-button.active {
      color: #38bdf8;
      border-color: #38bdf8;
    }
  `;
  document.head.appendChild(style);

  // Initialize
  loadPresets();
</script>
{% endblock %}
